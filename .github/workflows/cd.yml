name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Render
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Deploy Backend
        env:
          RENDER_TOKEN: ${{ secrets.RENDER_TOKEN }}
          RENDER_SERVICE_ID_BACKEND: ${{ secrets.RENDER_SERVICE_ID_BACKEND }}
        run: |
          echo "üöÄ Deploying backend to Render..."
          
          if [ -z "$RENDER_TOKEN" ]; then
            echo "‚ùå RENDER_TOKEN not found"
            exit 1
          fi
          
          if [ -z "$RENDER_SERVICE_ID_BACKEND" ]; then
            echo "‚ùå RENDER_SERVICE_ID_BACKEND not found"
            exit 1
          fi
          
          echo "‚úÖ Triggering backend deployment..."
          
          curl -X POST \
            -H "Authorization: Bearer $RENDER_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID_BACKEND/deploys" \
            -d '{"clearCache": "do_not_clear"}' \
            -w "\nHTTP Status: %{http_code}\n" \
            -s
          
          echo "‚úÖ Backend deployment triggered"

      - name: Deploy Frontend (Netlify Auto-Deploy)
        run: |
          echo "üöÄ Frontend deployment handled by Netlify..."
          echo "‚úÖ Netlify automatically deploys when code is pushed to GitHub"
          echo "‚úÖ No manual deployment needed for frontend"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting 60 seconds for deployment to start..."
          sleep 60
          echo "‚úÖ Deployment wait completed"

      - name: Simple health check
        run: |
          echo "üè• Quick health check..."
          
          echo "üîç Testing BACKEND_URL secret..."
          echo "BACKEND_URL value: ${{ secrets.BACKEND_URL }}"
          
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            echo "‚úÖ BACKEND_URL secret found"
            echo "üîç Checking backend..."
            curl -f "${{ secrets.BACKEND_URL }}/api/public/companies" && echo "‚úÖ Backend OK" || echo "‚ö†Ô∏è Backend check failed"
          else
            echo "‚ùå BACKEND_URL secret not found or empty"
          fi
          
          echo "üîç Frontend health check skipped (handled by Netlify)"
          echo "‚úÖ Frontend auto-deploys via Netlify"

      - name: Success notification
        run: |
          echo "üéâ Backend deployment completed!"
          echo "üîó Backend: ${{ secrets.BACKEND_URL }}"
          echo "üîó Frontend: Auto-deployed via Netlify" 