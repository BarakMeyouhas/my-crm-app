name: CD - Simple Deployment

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main, feature/cd-pipeline]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Render
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Deploy Backend
        run: |
          echo "ğŸš€ Deploying backend to Render..."
          
          if [ -z "${{ secrets.RENDER_TOKEN }}" ]; then
            echo "âŒ RENDER_TOKEN not found"
            exit 1
          fi
          
          if [ -z "${{ secrets.RENDER_SERVICE_ID_BACKEND }}" ]; then
            echo "âŒ RENDER_SERVICE_ID_BACKEND not found"
            exit 1
          fi
          
          echo "âœ… Triggering backend deployment..."
          
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID_BACKEND }}/deploys" \
            -d '{"clearCache": "do_not_clear"}' \
            -w "\nHTTP Status: %{http_code}\n" \
            -s
          
          echo "âœ… Backend deployment triggered"

      - name: Deploy Frontend (Netlify Auto-Deploy)
        run: |
          echo "ğŸš€ Frontend deployment handled by Netlify..."
          echo "âœ… Netlify automatically deploys when code is pushed to GitHub"
          echo "âœ… No manual deployment needed for frontend"

      - name: Wait for deployment
        run: |
          echo "â³ Waiting 60 seconds for deployment to start..."
          sleep 60
          echo "âœ… Deployment wait completed"

      - name: Simple health check
        run: |
          echo "ğŸ¥ Quick health check..."
          
          echo "ğŸ” Testing BACKEND_URL secret..."
          echo "BACKEND_URL value: ${{ secrets.BACKEND_URL }}"
          
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            echo "âœ… BACKEND_URL secret found"
            echo "ğŸ” Checking backend..."
            curl -f "${{ secrets.BACKEND_URL }}/api/public/companies" && echo "âœ… Backend OK" || echo "âš ï¸ Backend check failed"
          else
            echo "âŒ BACKEND_URL secret not found or empty"
          fi
          
          echo "ğŸ” Frontend health check skipped (handled by Netlify)"
          echo "âœ… Frontend auto-deploys via Netlify"

      - name: Success notification
        run: |
          echo "ğŸ‰ Backend deployment completed!"
          echo "ğŸ”— Backend: ${{ secrets.BACKEND_URL }}"
          echo "ğŸ”— Frontend: Auto-deployed via Netlify" 